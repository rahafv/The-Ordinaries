{% extends 'base_content.html' %}
{% load bootstrap_pagination %}
{% load humanize %}
{% block title %}Chat{% endblock %}
{% block content %}
<script>
    $(document).ready(function(){
    setInterval(function(){
        $.ajax({
            type: 'GET',
            url : "/getMessages/{{club.id}}",
            success: function(response){
                console.log(response);
                $("#display").empty();
                for (var key in response.chats) {
                    if(response.username != response.users[key]) {
                        var temp="<div id=rcorners1 class='container darker text-white mb-2'><b>"+response.users[key]+"</b>"+
                            "<span class='time-left'> &nbsp;&middot;&nbsp;"+response.chats[key].created_at+"</span><p>"+
                            response.chats[key].message+"</p></div>";                    }
                    else {
                        var temp="<div id=rcorners2 class='container darker text-white mb-2'><b>"+response.users[key]+"</b>"+
                            "<span class='time-left' > &nbsp;&middot;&nbsp;"+response.chats[key].created_at+"</span><p>"+
                            response.chats[key].message+"</p></div>";
                    }
                    $("#display").append(temp);
                }
                $("#clubMessage").empty();
                $("#clubMessageTime").empty();
                for (var key in response.messages) {
                    var m = response.messages[key].name+ ": " + response.messages[key].message
                    var t = response.messages[key].time
                    $("#clubMessage").append(m);
                    $("#clubMessageTime").append(t);
                }
            }
        });
    },1000);
    })

</script>

<div class="container">
    <div class="row">
        <div class="col-12">
            <div class="row mt-2">
                <div id="chats" class="col-4" style="">
                    <div style="text-align:center; background-color:SlateGrey; padding:15px">
                        <b>Chats</b>
                    </div>
                    <div class="scroll" style="height: 474px;">
                    
                        <table class="table user-list">
                            <tbody>
                                {% for userClub in user.clubs.all %}
                                    <tr>
                                        <td style="width:50px; padding-top: 14px">
                                            <svg width="50" height="50">
                                                <rect rx="2" ry="2" width="50" height="50"
                                                style="fill:#1c2a57;stroke-width:5;opacity:0.5" />
                                            </svg>
                                        </td>
                                        <td>
                                            <a href='{% url "chat_room" userClub.id %}'>{{userClub.name}}</a>
                                            <div id="clubMessage"></div>
                                            <div id="clubMessageTime"></div>
                                        </td>
                                        </tr>
                                {%endfor%}
                            </tbody>
                        </table>
                    </div>
                </div>
                <div class="col-8">
                    <div id="chatBox">    
                        <div style="background-color:SlateGrey; padding:15px;">
                            <b>{{club.name}} chat room</b>
                        </div>
                        <div id="display" class="scroll"></div>
                    </div>
                    <div>
                        <form id="post-form" class="form-inline d-flex">
                            {% csrf_token %}
                            <input type="hidden" name="username" id="username" value="{{user.username}}"/>
                            <input type="hidden" name="club_id" id="club_id" value="{{club.id}}"/>
                            <input type="text" name="message" id="message" class="form-control" style="width: 750"/>
                            <input type="submit" class="btn btn-dark" value="Send">
                        </form>
                    </div>
                </div>
            </div>
        </div>  
    </div>
</div>

<script type="text/javascript">
    $(document).on('submit','#post-form',function(e){
      e.preventDefault();
  
      $.ajax({
        type:'POST',
        url:'/send',
        data:{
            username:$('#username').val(),
            club_id:$('#club_id').val(),
            message:$('#message').val(),
          csrfmiddlewaretoken:$('input[name=csrfmiddlewaretoken]').val(),
        },
        success: function(data){
           // alert(data)
        }
      });
      document.getElementById('message').value = ''
    });
  </script>

{% endblock %}
